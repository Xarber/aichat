let body = otherargs[0].body;
const deasync = require('deasync');
const {parseCookies} = require('./js-modules/cookies.cjs');
const ollama = require("ollama").default;

function deasyncPromise(promise) {
    let isDone = false;
    let result, error;
    promise.then((res) => {
        result = res;
        isDone = true;
    })
    .catch((err) => {
        error = err;
        isDone = true;
    });
    while (!isDone) deasync.sleep(100);
    if (error) throw error;
    return result;
}

const cookies = parseCookies(otherargs[0]);

console.log("Access", cookies);

otherargs[2].setHeader('Transfer-Encoding', 'chunked');
otherargs[2].setHeader('Content-Type', 'text/plain');

if ((body.prompt && body.prompt.length > 0) || (body.messages && body.messages.length > 0)) deasyncPromise(new Promise(async (r)=>{
    let totalResponse = "";
    const response = await ollama.chat({
        model: "gemma2:2b" ?? body.model,
        messages: [...(body.messages ?? [{
            role: "user",
            content: body.prompt ?? "Why is the sky blue?"
        }])],
        stream: true
    });
    for await (const data of response) {
        totalResponse += data.message.content;
        const output = {
            status: true,
            model: data.model,
            response: data.message.content,
            totalResponse: totalResponse,
            time: data.total_duration,
            done: data.done
        };
        otherargs[2].write(JSON.stringify(output)+"\n");
        if (data.done === true) return r();
    }
}));
else echo({status: false, response: "Please enter a prompt."});

/*

async function fetchAndStream(url, options, onDataCallback = console.log) {
    const response = await fetch(url, options);
    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let result = '';

    while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        result += decoder.decode(value, { stream: true });
        onDataCallback(result, false);
    }

    onDataCallback(result, true);
    return result;
}
fetchAndStream('/api/generate', {
    method: "POST",
    body: JSON.stringify({
        model: "gemma2",
        prompt: "Hi, why is the sky blue?"
    })
}, (data)=>{
    data = data.split("\n");
    document.body.innerHTML = `<pre style="word-wrap: break-word; white-space: pre-wrap;font-family: font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;"></pre>`;
    document.body.querySelector('pre').innerHTML += data;
});

*/